<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>BNB Donations — Auto CSV</title>
<style>
  :root{--bg:#04050a;--text:#e8eef7;--muted:#9aa3b2;--accent:#f3ba2f}
  html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;background:linear-gradient(180deg,#070812,#02030a);color:var(--text);display:flex;align-items:center;justify-content:center}
  .wrap{max-width:980px;padding:28px;text-align:center}
  h1{margin:0 0 8px;color:var(--muted);font-weight:600;font-size:18px}
  .amount{font-size:clamp(48px,12vw,120px);font-weight:800;color:var(--accent);line-height:1}
  .meta{margin-top:8px;color:var(--muted);font-size:13px}
  .controls{margin-top:18px;display:flex;gap:10px;justify-content:center;flex-wrap:wrap}
  input[type="file"]{display:none}
  .btn{background:#0f1420;border:1px solid #233048;color:#eaf1ff;padding:10px 14px;border-radius:10px;cursor:pointer}
  .small{font-size:12px;color:var(--muted)}
  .error{color:#ff8a8a;margin-top:10px}
</style>
</head>
<body>
  <div class="wrap">
    <h1>BNB Donations Total</h1>
    <div id="amount" class="amount">0 BNB</div>
    <div id="meta" class="meta">No data yet — upload a CSV or provide <code>?csv_url=</code></div>

    <div class="controls" aria-hidden>
      <label class="btn">Upload CSV<input id="csv" type="file" accept=".csv" /></label>
      <button class="btn" id="btnFetch">Fetch CSV URL</button>
    </div>

    <div id="err" class="error" style="display:none"></div>
  </div>

<script>
/* Minimal, robust CSV-only UI. Auto-fetches csv_url ?csv_url=... on load.
   Query params:
     csv_url= (public URL to CSV) — e.g. https://czfund.vercel.app/files/txs.csv
     currency=bnb|dollar (default bnb)
     from=0x... (optional)
     to=0x...   (optional)
     divide=1|2 (display divider)
*/

const elAmount = document.getElementById('amount');
const elMeta = document.getElementById('meta');
const elErr = document.getElementById('err');
const fileInput = document.getElementById('csv');
const btnFetch = document.getElementById('btnFetch');

const qs = new URLSearchParams(location.search);
const CSV_URL = qs.get('csv_url') || '';
const CURRENCY = (qs.get('currency') || 'bnb').toLowerCase();
const FILTER_FROM = (qs.get('from') || '').toLowerCase();
const FILTER_TO   = (qs.get('to')   || '').toLowerCase();
const DIVIDE = Number(qs.get('divide') || 1);

function showError(msg){ elErr.style.display='block'; elErr.textContent=msg; }
function clearError(){ elErr.style.display='none'; elErr.textContent=''; }

function parseCSV(text){
  // Simple CSV parser tolerant to quoted commas
  const rows = [];
  let cur = '', inQ=false, row=[];
  for (let i=0;i<text.length;i++){
    const ch=text[i];
    if (ch==='\"') { inQ=!inQ; cur+=ch; continue; }
    if (ch===',' && !inQ){ row.push(cur.trim()); cur=''; continue; }
    if ((ch==='\n' || ch==='\r') && !inQ){
      if (cur!=='' || row.length>0){ row.push(cur.trim()); rows.push(row); row=[]; cur=''; }
      while (i+1<text.length && (text[i+1]==='\n' || text[i+1]==='\r')) i++;
      continue;
    }
    cur+=ch;
  }
  if (cur!=='' || row.length>0){ row.push(cur.trim()); rows.push(row); }
  if (rows.length===0) return {headers:[],rows:[]};
  const headers = rows[0].map(h=>h.replace(/^"|"$/g,'').trim());
  const data = rows.slice(1).map(r=>{
    const o={};
    for (let i=0;i<headers.length;i++) o[headers[i]] = (r[i]||'').replace(/^"|"$/g,'').trim();
    return o;
  });
  return { headers, rows: data };
}

function extractBNBFromRow(obj){
  // look for common numeric fields first
  const rowText = Object.values(obj).join(' ');
  const candidates = ['value','amount','bnb','tokenValue','quantity'];
  for (const c of candidates){
    if (obj[c] && obj[c].length && !isNaN(Number(obj[c]))){
      return Number(obj[c]);
    }
  }
  // match "12.34 BNB"
  const re = /([0-9]+(?:\.[0-9]+)?)\s*BNB/ig;
  let m, sum=0, found=false;
  while ((m=re.exec(rowText))!==null){ sum+=Number(m[1]); found=true; }
  if(found) return sum;
  // try bare decimal numeric fallback (last number typically value)
  const numRe = /([0-9]+\.[0-9]+)/g;
  const arr = rowText.match(numRe);
  if(arr && arr.length) return Number(arr[arr.length-1]);
  return 0;
}

function extractDollarFromRow(obj){
  const rowText = Object.values(obj).join(' ');
  const re = /\$[0-9,]+(?:\.[0-9]+)?/g;
  const m = rowText.match(re);
  if(!m) return 0;
  return m.reduce((s,t)=> s + parseFloat(t.replace(/[$,]/g,'')), 0);
}

function rowMatchesFilter(obj){
  if(!FILTER_FROM && !FILTER_TO) return true;
  const lowerKeys = Object.keys(obj).reduce((acc,k)=>{ acc[k.toLowerCase()]=k; return acc; },{});
  const findKey = name => Object.keys(lowerKeys).find(k=>k.includes(name));
  const fromKey = findKey('from') || findKey('sender') || null;
  const toKey   = findKey('to')   || findKey('receiver') || null;
  if(fromKey && FILTER_FROM && (obj[fromKey]||'').toLowerCase() !== FILTER_FROM) return false;
  if(toKey   && FILTER_TO   && (obj[toKey]  ||'').toLowerCase() !== FILTER_TO) return false;
  return true;
}

function renderResult(total, matchedCount){
  const displayed = total / (DIVIDE || 1);
  const unit = (CURRENCY==='bnb') ? 'BNB' : '$';
  elAmount.textContent = `${displayed.toLocaleString(undefined,{maximumFractionDigits:8})} ${unit}`;
  elMeta.textContent = `Matched rows: ${matchedCount} · Raw total: ${total.toLocaleString(undefined,{maximumFractionDigits:8})} ${unit}${DIVIDE&&DIVIDE!==1?(' · ÷ '+DIVIDE):''}`;
  clearError();
}

async function processCSVText(text){
  try{
    const {headers, rows} = parseCSV(text);
    let total=0, matched=0;
    for (const r of rows){
      if (!rowMatchesFilter(r)) continue;
      const val = (CURRENCY==='bnb') ? extractBNBFromRow(r) : extractDollarFromRow(r);
      if (val>0){ total+=val; matched++; }
    }
    renderResult(total, matched);
  }catch(e){
    showError('CSV parse error: '+ (e.message||e));
  }
}

async function fetchCsvText(url){
  // if URL is on same domain /api/proxy pattern not needed; rely on public S3 or backdoor endpoint
  const res = await fetch(url, { credentials: 'omit' });
  if(!res.ok) throw new Error('fetch failed: '+res.status);
  return await res.text();
}

fileInput.addEventListener('change', async (ev)=>{
  const f = ev.target.files && ev.target.files[0];
  if(!f) return;
  const text = await f.text();
  await processCSVText(text);
});

btnFetch.addEventListener('click', async ()=>{
  if(!CSV_URL) return showError('No csv_url provided in query string');
  try{
    elMeta.textContent = 'Fetching CSV…';
    const txt = await fetchCsvText(CSV_URL);
    await processCSVText(txt);
  }catch(e){
    showError('Fetch failed: '+ (e.message || e));
  }
});

// auto-run if csv_url present
(async function auto(){
  if(CSV_URL){
    try{
      elMeta.textContent = 'Auto-fetching CSV…';
      const txt = await fetchCsvText(CSV_URL);
      await processCSVText(txt);
    }catch(e){
      showError('Auto-fetch failed: ' + (e.message||e));
    }
  }
})();
</script>
</body>
</html>
