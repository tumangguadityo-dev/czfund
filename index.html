<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BNB Donation Counter – CSV Upload</title>
  <style>
    :root { --bg:#0a0b0e; --text:#e8eef7; --muted:#9aa3b2; --accent:#f3ba2f; }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;display:flex;align-items:center;justify-content:center;background:#0a0b0e;color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial}
    .wrap{width:100%;max-width:900px;padding:24px;text-align:center}
    h1{font-size:clamp(18px,3vw,28px);margin-bottom:20px;color:var(--muted)}
    .amt{font-weight:800;font-size:clamp(42px,12vw,120px);line-height:1.05;letter-spacing:1px;color:var(--accent)}
    .sub{margin-top:10px;color:var(--muted);font-size:clamp(12px,1.6vw,14px)}
    .err{color:#ff8a8a}
    input[type=file]{display:none}
    .btn{display:none} /* hide upload button UI */
  </style>
</head>
<body>
  <div class="wrap">
    <h1>BNB Donations Total</h1>
    <div id="amount" class="amt">0 BNB</div>
    <div id="meta" class="sub">Waiting for CSV data…</div>
  </div>

<script>
(function(){
  var elAmt = document.getElementById('amount');
  var elMeta = document.getElementById('meta');
  var elFrom = document.getElementById('fromA');
  var elTo   = document.getElementById('toB');

  // Defaults: your addresses
  var DEFAULT_FROM = '0xbf310C4060c5399BE02B51f07850BAFF91269179';
  var DEFAULT_TO   = '0x28816c4C4792467390C90e5B426F198570E29307';

  var qs = new URLSearchParams(location.search);
  var ADDR_FROM = (qs.get('from') || DEFAULT_FROM).trim();
  var ADDR_TO   = (qs.get('to')   || DEFAULT_TO  ).trim();
  var APIKEY    = (qs.get('apikey')||'').trim();
  var OFFSET    = Math.min(Math.max(parseInt(qs.get('offset')||'200',10)||200,10),10000);
  var DIVIDE    = Number(qs.get('divide')||1);
  var REFRESH   = Number(qs.get('refresh_ms')||60000);

  if(elFrom) elFrom.textContent = ADDR_FROM;
  if(elTo)   elTo.textContent   = ADDR_TO;

  function formatDecimalString(decStr){
    if(!decStr.includes('.')){
      try { return new Intl.NumberFormat().format(BigInt(decStr)) + ' BNB'; } catch(_) { return decStr + ' BNB'; }
    }
    var parts = decStr.split('.');
    var head = parts[0];
    var tail = parts[1].replace(/0+$/,'').slice(0,8);
    try { head = new Intl.NumberFormat().format(BigInt(head)); } catch(_) {}
    return head + (tail?'.'+tail:'') + ' BNB';
  }

  function weiToBNBString(wei){
    var w = typeof wei === 'bigint' ? wei : BigInt(wei);
    var base = 1000000000000000000n;
    var intPart = w / base;
    var frac = (w % base).toString().padStart(18,'0');
    frac = frac.replace(/0+$/,'');
    return frac ? intPart.toString() + '.' + frac : intPart.toString();
  }

  async function fetchJSON(url){
    try{
      var p = '/api/proxy?url=' + encodeURIComponent(url);
      var r = await fetch(p);
      if(!r.ok) throw new Error('proxy '+r.status);
      var t = await r.text();
      return JSON.parse(t);
    }catch(_){
      var r2 = await fetch(url);
      var t2 = await r2.text();
      return JSON.parse(t2);
    }
  }

  async function sumEndpoint(action){
    var page = 1; var totalWei = 0n; var hits = 0; var reqs = 0;
    var fromLC = ADDR_FROM.toLowerCase();
    var toLC   = ADDR_TO.toLowerCase();
    while(true){
      var url = 'https://api.bscscan.com/api?module=account&action=' + action + '&address=' + ADDR_FROM + '&startblock=0&endblock=99999999&page=' + page + '&offset=' + OFFSET + '&sort=asc&apikey=' + APIKEY;
      reqs++;
      var data = await fetchJSON(url);
      if(!data || data.status!=='1' || !Array.isArray(data.result) || data.result.length===0) break;
      for(var i=0;i<data.result.length;i++){
        var tx = data.result[i];
        var f = (tx.from||'').toLowerCase();
        var to = (tx.to||'').toLowerCase();
        if(f===fromLC && to===toLC){
          try{
            var v = BigInt(tx.value || '0');
            if(v>0n){ totalWei += v; hits++; }
          }catch(e){}
        }
      }
      if(data.result.length < OFFSET) break;
      page++; if(page>2000) break;
    }
    return { totalWei: totalWei, hits: hits, requests: reqs };
  }

  async function compute(){
    if(!APIKEY){
      elMeta.innerHTML = '<span class="err">Missing apikey.</span> Add <code>?apikey=YOUR_BSCSCAN_KEY</code> to the URL.';
      return;
    }
    elMeta.textContent = 'Fetching…';
    var t0 = performance.now();
    try{
      var normal = await sumEndpoint('txlist');
      var internal = await sumEndpoint('txlistinternal');
      var totalWei = normal.totalWei + internal.totalWei;
      var totalBNBStr = weiToBNBString(totalWei);
      var div = DIVIDE || 1;
      function divideDecimalString(decStr, d){
        var parts = decStr.split('.');
        var whole = parts[0];
        var frac = (parts[1]||'').padEnd(18,'0').slice(0,18);
        var wei = BigInt(whole) * 1000000000000000000n + BigInt(frac);
        var out = wei / BigInt(d);
        return weiToBNBString(out);
      }
      var shownStr = div===1 ? totalBNBStr : divideDecimalString(totalBNBStr, div);
      elAmt.textContent = formatDecimalString(shownStr);
      elAmt.classList.add('blink'); setTimeout(function(){ elAmt.classList.remove('blink'); }, 1100);
      var t1 = performance.now();
      elMeta.textContent = 'Normal hits: ' + normal.hits + ' · Internal hits: ' + internal.hits + ' · Pages: ' + (normal.requests+internal.requests) + ' · Offset: ' + OFFSET + ' · ' + ((t1-t0)|0) + ' ms' + (DIVIDE&&DIVIDE!==1?(' · ÷ '+DIVIDE):'');
    }catch(err){
      console.error(err);
      elMeta.innerHTML = '<span class="err">Error:</span> ' + (err.message||err);
    }
  }

  compute();
  if(REFRESH>0) setInterval(compute, REFRESH);
})();
</script>
</body>
</html>
