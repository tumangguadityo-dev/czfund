<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BNB Sent – Auto A ➜ B (Etherscan V2 API)</title>
  <style>
    :root { --bg:#0a0b0e; --text:#e8eef7; --muted:#9aa3b2; --accent:#f3ba2f; }
    html,body{height:100%;margin:0;display:flex;align-items:center;justify-content:center;
      background:#0a0b0e;color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial}
    .wrap{width:100%;max-width:1100px;padding:24px;text-align:center}
    h1{font-size:18px;font-weight:600;color:var(--muted);margin:0 0 10px}
    .amt{font-weight:800;font-size:clamp(42px,12vw,120px);line-height:1.05;letter-spacing:1px;color:var(--accent)}
    .sub{margin-top:10px;color:var(--muted);font-size:14px}
    .err{color:#ff8a8a}
    .blink{animation:blink 1s step-start 2}
    @keyframes blink{50%{opacity:.35}}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>BNB sent from <code id="fromA"></code> ➜ <code id="toB"></code></h1>
    <div id="amount" class="amt">0 BNB</div>
    <div id="meta" class="sub">Waiting for data…</div>
  </div>

<script>
(function(){
  var elAmt = document.getElementById('amount');
  var elMeta = document.getElementById('meta');
  var elFrom = document.getElementById('fromA');
  var elTo   = document.getElementById('toB');

  const BASE = "https://api.etherscan.io/v2/api";  // Etherscan V2 base
  const CHAIN = 56; // BSC

  var DEFAULT_FROM = '0xbf310C4060c5399BE02B51f07850BAFF91269179';
  var DEFAULT_TO   = '0x28816c4C4792467390C90e5B426F198570E29307';

  var qs = new URLSearchParams(location.search);
  var ADDR_FROM = (qs.get('from') || DEFAULT_FROM).trim();
  var ADDR_TO   = (qs.get('to')   || DEFAULT_TO  ).trim();
  var APIKEY    = (qs.get('apikey')||'').trim();
  var OFFSET    = Math.min(Math.max(parseInt(qs.get('offset')||'200',10)||200,10),10000);
  var DIVIDE    = Number(qs.get('divide')||1);
  var REFRESH   = Number(qs.get('refresh_ms')||60000);

  elFrom.textContent = ADDR_FROM;
  elTo.textContent   = ADDR_TO;

  function formatDecimalString(decStr){
    if(!decStr.includes('.')){
      try { return new Intl.NumberFormat().format(BigInt(decStr)) + ' BNB'; }
      catch(_) { return decStr + ' BNB'; }
    }
    var [head, tail] = decStr.split('.');
    tail = tail.replace(/0+$/,'').slice(0,8);
    try { head = new Intl.NumberFormat().format(BigInt(head)); } catch(_) {}
    return head + (tail?'.'+tail:'') + ' BNB';
  }

  function weiToBNBString(wei){
    var w = typeof wei === 'bigint' ? wei : BigInt(wei);
    var base = 1000000000000000000n;
    var intPart = w / base;
    var frac = (w % base).toString().padStart(18,'0');
    frac = frac.replace(/0+$/,'');
    return frac ? intPart.toString() + '.' + frac : intPart.toString();
  }

  async function fetchJSON(url){
    const r = await fetch(url);
    const t = await r.text();
    return JSON.parse(t);
  }

  async function getAllNormalFromA(){
    var page=1, totalWeiToB=0n, reqs=0, hitsToB=0, hashes=[];
    var fromLC=ADDR_FROM.toLowerCase(), toLC=ADDR_TO.toLowerCase();
    while(true){
      var url = `${BASE}?chainid=${CHAIN}&module=account&action=txlist&address=${ADDR_FROM}&startblock=0&endblock=99999999&page=${page}&offset=${OFFSET}&sort=asc&apikey=${APIKEY}`;
      reqs++;
      var data = await fetchJSON(url);
      if(!data || !Array.isArray(data.result) || data.result.length===0) break;
      for(var tx of data.result){
        if((tx.from||'').toLowerCase() !== fromLC) continue;
        hashes.push(tx.hash);
        if((tx.to||'').toLowerCase() === toLC && tx.isError==='0'){
          try{ var v=BigInt(tx.value||'0'); if(v>0n){ totalWeiToB+=v; hitsToB++; } }catch(_){}
        }
      }
      if(data.result.length<OFFSET) break;
      page++; if(page>2000) break;
    }
    return { totalWeiToB, hashes, reqs, hitsToB };
  }

  async function sumInternalsByHashes(hashes){
    var toLC=ADDR_TO.toLowerCase(), totalWei=0n, hits=0, reqs=0;
    var idx=0, CONC=3;
    async function worker(){
      while(idx<hashes.length){
        var h = hashes[idx++];
        var url = `${BASE}?chainid=${CHAIN}&module=account&action=txlistinternal&txhash=${h}&apikey=${APIKEY}`;
        reqs++;
        try{
          var data = await fetchJSON(url);
          if(data && Array.isArray(data.result)){
            for(var itx of data.result){
              if((itx.to||'').toLowerCase()===toLC){
                try{ var v=BigInt(itx.value||'0'); if(v>0n){ totalWei+=v; hits++; } }catch(_){}
              }
            }
          }
        }catch(_){}
        await new Promise(r=>setTimeout(r,120)); // delay to respect rate limit
      }
    }
    await Promise.all(Array.from({length:Math.min(CONC,hashes.length)},()=>worker()));
    return { totalWei, hits, reqs };
  }

  async function compute(){
    if(!APIKEY){
      elMeta.innerHTML='<span class=\"err\">Missing apikey.</span> Add ?apikey=YOUR_KEY to URL.';
      return;
    }
    elMeta.textContent='Fetching…';
    var t0=performance.now();
    try{
      var norm=await getAllNormalFromA();
      elMeta.textContent='Fetching internal…';
      var intr=await sumInternalsByHashes(norm.hashes);

      var totalWei=norm.totalWeiToB+intr.totalWei;
      var totalBNBStr=weiToBNBString(totalWei);

      var div=DIVIDE||1;
      function divideDecimalString(decStr,d){
        var [whole, frac=''] = decStr.split('.');
        frac=frac.padEnd(18,'0').slice(0,18);
        var wei=BigInt(whole)*1000000000000000000n+BigInt(frac);
        var out=wei/BigInt(d);
        return weiToBNBString(out);
      }
      var shownStr=div===1?totalBNBStr:divideDecimalString(totalBNBStr,div);

      elAmt.textContent=formatDecimalString(shownStr);
      elAmt.classList.add('blink'); setTimeout(()=>elAmt.classList.remove('blink'),1100);
      var t1=performance.now();
      elMeta.textContent=`Direct hits: ${norm.hitsToB} · Internal hits: ${intr.hits} · API calls: ${norm.reqs+intr.reqs} · ${(t1-t0)|0} ms`;
    }catch(err){
      elMeta.innerHTML='<span class=\"err\">Error:</span> '+(err.message||err);
    }
  }

  compute();
  if(REFRESH>0) setInterval(compute,REFRESH);
})();
</script>
</body>
</html>
